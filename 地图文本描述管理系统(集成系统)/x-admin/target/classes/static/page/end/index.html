<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta HTTP-EQUIV="pragma" CONTENT="no-cache">
    <meta HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">
    <meta HTTP-EQUIV="expires" CONTENT="0">
    <title>首页</title>
    <style>
        body,
        html,
        #container { // 地图的样式
        overflow: hidden;
            width: 90%;
            height: 90%;
            font-family: "微软雅黑";
            margin: 0;
            margin-left: 0px;
            position: absolute;
            float: left;
        }
        .info { // 按钮的样式
        z-index: 999;
            width: auto;
            min-width: 16rem;
            padding: .75rem 1.25rem;
            margin-left: 1.25rem;
            position: fixed;
            top: 35rem;
            background-color: rgba(265, 265, 265, 0.9);
            border-radius: .25rem;
            font-size: 14px;
            color: #666;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.3);
        }
        #zoominput {
            height: 24px;
            width: 80px;
            padding-left: 8px;
        }
        #change-btn {
            height: 30px;
            background: #5679ea;
            border: 0;
            padding: 0 10px 0 10px;
            margin-right: 8px;
            cursor: pointer;
            border-radius: 2px;
            color: #fff;
            font-size: 14px;
        }
    </style>
    <link rel="stylesheet" href="../../css/element.css">
    <link rel="stylesheet" href="../../css/base.css">
    <script src="http://api.map.baidu.com/api?type=webgl&v=1.0&ak=4jUxlUB23hUinaXofRahjpwRNhrpgkmn"></script>
</head>
<body>
<div id="wrapper" v-cloak>
    <div style="padding-bottom: 10px">
        <el-breadcrumb separator-class="el-icon-arrow-right">
            <el-breadcrumb-item @click.native="parent.changeIndex('index')">首页</el-breadcrumb-item>
        </el-breadcrumb>
    </div>

    <div style="height: 1px; margin: 10px 0; background-color: white"></div>
    <el-input v-model="input" style="width: 40%;" placeholder="请输入对该地点的描述"
              @keyup.enter.native="submit" minlength="1" type="textarea"></el-input>
    <el-button @click="submit" type="primary"  style="margin: 10px 0px">提交</el-button>
    <el-popover
            placement="right"
            width="400"
            trigger="click">
        <el-table :data="descriptionData">
            <el-table-column width="80" property="uid" label="用户id"></el-table-column>
            <el-table-column width="200" property="name" label="描述"></el-table-column>
        </el-table>
        <el-button slot="reference" @click="loadDescription()" style="margin: 10px 160px">
            查看该地点已有描述
        </el-button>
    </el-popover>
</div>

<div class="info">
    <button id="change-btn" onclick="setNewCenter()">随机地图中心点</button>
    <button id="change-btn" onclick="getMapCenter()">获取当前中心点</button>
</div>
<div id="container">
</div>

<script src="../../js/jquery.min.js"></script>
<script src="../../js/vue.min.js"></script>
<script src="../../js/element.js"></script>
<script src="../../js/tinymce/tinymce.min.js"></script>


<script>

    var map = new BMapGL.Map('container', {
        minZoom:18,
        maxZoom:18
    });
    var precision = 5;
    map.centerAndZoom(new BMapGL.Point(116.2, 39.8), 18)
    map.enableScrollWheelZoom(false)
    map.disableDragging();
    function setNewCenter(){
        var lng = 116.2 + Math.floor(Math.random() * 15) * 0.02;
        var lat = 39.8 + Math.floor(Math.random() * 10) * 0.02;
        var point = new BMapGL.Point(lng, lat);
        map.setCenter(point); // 设置地图中心点
    }
    function getMapCenter(){
        var cen = map.getCenter();
        alert('当前地图中心点: (' + cen.lng.toFixed(precision) + ', ' + cen.lat.toFixed(precision) + ')');
    }

    new Vue({
        el: "#wrapper",
        data: {
            pid: 0,
            lng: 0,
            lat: 0,
            options: [],
            fileList: [],
            user: {},
            descriptionData: [],
            pageNum: 1,
            pageSize: 10,
            total: 0,
            dialogFormVisible: false,
            entity: {},
            isCollapse: false,
            input: '',
            vis: false
        },
        created() {
            this.user = sessionStorage.getItem("user") ? JSON.parse(sessionStorage.getItem("user")) : {};
            this.loadTable();
        },
        methods: {
            setPer(obj) {
                this.entity = JSON.parse(JSON.stringify(obj))
                this.vis = true;
            },
            fileSuccessUpload(res) {
                this.entity.file = "http://localhost:9999/files/" + res.data;
                this.entity.img = "http://localhost:9999/files/" + res.data;
                console.log(res)
            },
            successUpload(value) {
                $.get("/api/position/upload/" + value.data).then(res => {
                    if (res.code === '0') {
                        this.$message({
                            message: "导入成功",
                            type: "success"
                        });
                        this.loadTable()
                    }
                })
            },
            changeState(obj, state) {  // 审核
                this.entity = JSON.parse(JSON.stringify(obj));
                this.entity.state = state;
                this.save();
            },
            handleCollapse() {
                this.isCollapse = !this.isCollapse;
            },
            logout() {
                $.get("/api/user/logout");
                sessionStorage.removeItem("user");
                location.href = "/page/end/login.html";
            },
            loadDescription() {
                var cen = map.getCenter();
                $.get("/api/position/" + "/center?pageNum=" + this.pageNum + "&pageSize=" + this.pageSize
                    + "&lng=" + cen.lng.toFixed(precision) + "&lat=" + cen.lat.toFixed(precision)).then(res => {
                    if(res.data.total==0){
                        this.descriptionData = [];
                        this.total = 0;
                    }
                    else{
                        this.pid = res.data.records[0].id;
                        $.get("/api/description/" + "/page/pid?pageNum=" + this.pageNum
                            + "&pageSize=" + this.pageSize + "&pid=" + this.pid).then(res => {
                            this.descriptionData = res.data.records;
                            this.total = res.data.total;
                        })
                    }
                })

                $.get("/api/").then(res => {
                    this.options = res.data;
                })
            },
            exp() {   // excel 导出
                window.open(urlBase + "/export");
            },
            handleSizeChange(pageSize) {
                this.pageSize = pageSize;
                this.loadTable();
            },
            handleCurrentChange(pageNum) {
                this.pageNum = pageNum;
                this.loadTable();
            },
            add() {
                this.entity = {};
                this.fileList = [];
                this.dialogFormVisible = true;
            },
            savePosition() {
                let type = this.entity.id ? "PUT" : "POST";
                $.ajax({
                    url: "/api/position/",
                    type: type,
                    contentType: "application/json",
                    data: JSON.stringify(this.entity)
                }).then(res => {
                    if (res.code === '0') {
                        this.$message({
                            message: "地点保存成功",
                            type: "success"
                        });
                    } else {
                        this.$message({
                            message: res.msg,
                            type: "error"
                        })
                    }
                })
            },
            saveDescription() {
                let type = this.entity.id ? "PUT" : "POST";
                $.ajax({
                    url: "/api/description/",
                    type: type,
                    contentType: "application/json",
                    data: JSON.stringify(this.entity)
                }).then(res => {
                    if (res.code === '0') {
                        this.$message({
                            message: "评论保存成功",
                            type: "success"
                        });
                    } else {
                        this.$message({
                            message: res.msg,
                            type: "error"
                        })
                    }
                })
            },
            edit(obj) {
                this.entity = JSON.parse(JSON.stringify(obj));
                this.fileList = [];
                this.dialogFormVisible = true;
            },
            del(id) {
                $.ajax({
                    url: urlBase + id,
                    type: "delete"
                }).then(res => {
                    if (res.code === '0') {
                        this.$message({
                            message: "删除成功",
                            type: "success"
                        })
                        this.loadTable();
                    } else {
                        this.$message({
                            message: res.msg,
                            type: "error"
                        })
                    }
                })
            },
            submit(){ // 点击提交评论的按钮后要进行的操作;
                var cen = map.getCenter();
                this.lng = cen.lng.toFixed(precision);
                this.lat = cen.lat.toFixed(precision);
                var sw_lng = map.getBounds().sw.lng.toFixed(precision);
                var sw_lat = map.getBounds().sw.lat.toFixed(precision);
                var ne_lng = map.getBounds().ne.lng.toFixed(precision);
                var ne_lat = map.getBounds().ne.lat.toFixed(precision);
                $.get("/api/position/" + "/center?pageNum=" + this.pageNum + "&pageSize=" + this.pageSize
                    + "&lng=" + this.lng + "&lat=" + this.lat).then(res => {
                    if(res.data.total==0){ // 如果没找到
                        this.entity = {centerLng:this.lng, centerLat:this.lat,
                            swLng:sw_lng, swLat:sw_lat, neLng:ne_lng, neLat:ne_lat};
                        this.savePosition();
                        this.submitDescription();
                        this.submitDescription();
                    }
                    else{
                        this.$message({
                            message: "该地点已存在",
                            type: "success"
                        })
                        this.submitDescription();
                    }
                })
            },
            submitDescription() {
                $.get("/api/position/" + "/center?pageNum=" + this.pageNum + "&pageSize=" + this.pageSize
                    + "&lng=" + this.lng + "&lat=" + this.lat).then(res => {
                    this.pid = res.data.records[0].id;
                    this.entity = {uid:this.user.id, pid:this.pid, name:this.input};
                    this.saveDescription();
                })
            }
        }
    })
</script>
</body>
</html>
